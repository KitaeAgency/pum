<?xml version="1.0" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <services>

        <!-- PUBLIC SERVICES -->

        <service id="pum" alias="pum_core.object_factory" />
        <service id="em_factory" alias="pum_core.em_factory" />

        <!-- SCHEMA MANAGER -->

        <service id="pum_core.object_factory" class="Pum\Core\ObjectFactory">
            <argument type="service" id="pum_core.builder_registry" />
            <argument type="service" id="pum_core.schema" />
            <argument type="service" id="pum_core.cache" />
            <argument type="service" id="pum_core.event_dispatcher" />
        </service>

        <service id="pum_core.schema" class="Pum\Core\Schema\DoctrineOrmSchema" public="false">
            <argument type="service" id="doctrine.orm.default_entity_manager" />
        </service>

        <service id="pum_core.event_dispatcher" alias="event_dispatcher" public="false" />

        <service id="pum_core.builder_registry" class="Pum\Core\BuilderRegistry\ContainerBuilderRegistry" public="false">
            <argument type="service" id="service_container" />
            <argument>%pum_core.builder_registry.type_ids%</argument>
            <argument>%pum_core.builder_registry.type_extension_ids%</argument>
            <argument>%pum_core.builder_registry.behavior_ids%</argument>
        </service>

        <service id="pum_core.cache" class="Pum\Core\Cache\StaticCache" public="false"/>

        <!-- EM FACTORY -->

        <service id="pum_core.em_factory" class="Pum\Extension\EmFactory\EmFactory">
            <argument type="service" id="pum" />
            <argument type="service" id="doctrine.dbal.default_connection" />
        </service>

        <!-- CONTEXT -->

        <service id="pum.context" class="Pum\Bundle\CoreBundle\PumContext">
            <argument type="service" id="pum" />
        </service>

        <service id="pum.oem" factory-service="pum.context" factory-method="getProjectOEM" class="Pum\Extension\EmFactory\Doctrine\ObjectEntityManager">
            <argument type="service" id="pum" />
        </service>

        <service id="pum.context.listener" class="Pum\Bundle\CoreBundle\EventListener\PumContextListener">
            <argument type="service" id="pum.context" />
            <argument type="service" id="router" />

            <tag name="kernel.event_subscriber" />
        </service>

        <!-- TYPES (must be public, lazy loaded) -->

        <service id="pum.type.text" class="Pum\Extension\Core\Type\TextType">
            <tag name="pum.type" alias="text" />
        </service>

        <service id="pum.type.simple" class="Pum\Extension\Core\Type\SimpleType">
            <tag name="pum.type" alias="simple" />
        </service>

        <!-- CONFIG -->

        <service id="pum.config" alias="pum_core.config" />

        <service id="pum_core.config" class="Pum\Config\MysqlConfig">
            <argument type="service" id="doctrine.dbal.default_connection" />
            <argument>pum_config</argument>
        </service>

    </services>
</container>
